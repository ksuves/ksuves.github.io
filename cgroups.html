<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cgroups ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</title>
<style>
  body {
    font-family: "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
    background: #fdfdfd;
    color: #222;
    margin: 0;
    padding: 2em;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }
  h1, h2, h3 {
    color: #333;
  }
  pre {
    background: #f4f4f4;
    border: 1px solid #ddd;
    padding: 1em;
    overflow-x: auto;
    border-radius: 8px;
  }
  code {
    background: #f4f4f4;
    padding: 0.2em 0.4em;
    border-radius: 4px;
  }
  .note {
    border-left: 4px solid #008080;
    background: #e8f6f6;
    padding: 0.8em 1em;
    margin: 1em 0;
  }
  footer {
    font-size: 0.9em;
    color: #555;
    border-top: 1px solid #ddd;
    margin-top: 2em;
    padding-top: 1em;
  }
</style>
</head>
<body>

<h1>Cgroups ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</h1>

<p><strong>Cgroups</strong> ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∏—Ö –ø–æ—Ç–æ–º–∫–æ–≤.</p>

<p><strong>–ó–∞–¥–∞—á–∞:</strong> –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–º—è—Ç–∏, –∑–∞–Ω–∏–º–∞–µ–º–æ–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏, –∑–∞–ø—É—â–µ–Ω–Ω—ã–º–∏ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (<code>testuser</code>).</p>

<h2>1. Subsystem</h2>

<p>–í —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ Cgroups —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ–Ω—è—Ç–∏–µ <em>subsystem</em> ‚Äî –∫—Ä–∏—Ç–µ—Ä–∏–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –æ–Ω –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è <code>memory</code>.</p>

<h2>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤ —è–¥—Ä–µ</h2>

<p>–ü—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ, —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Cgroups –≤–∫–ª—é—á–µ–Ω–∞ –≤ —è–¥—Ä–µ:</p>

<pre><code>astra linux # cat .config | grep -i cgroup
CONFIG_CGROUPS=y
# CONFIG_CGROUP_DEBUG is not set
CONFIG_CGROUP_NS=y
CONFIG_CGROUP_FREEZER=y
CONFIG_CGROUP_DEVICE=y
CONFIG_CGROUP_CPUACCT=y
CONFIG_CGROUP_MEM_RES_CTLR=y
# CONFIG_CGROUP_MEM_RES_CTLR_SWAP is not set
CONFIG_CGROUP_SCHED=y
CONFIG_BLK_CGROUP=y
# CONFIG_DEBUG_BLK_CGROUP is not set
</code></pre>

<p>–¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã:</p>

<pre><code>astra linux # cat /proc/cgroups 
#subsys_name    hierarchy    num_cgroups    enabled
cpuset    0    1    1
ns    0    1    1
cpu    0    1    1
cpuacct    0    1    1
memory    0    1    1
devices    0    1    1
freezer    0    1    1
blkio    0    1    1
</code></pre>

<h2>3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∏—Å—Ç–µ–º—ã</h2>

<p>–û–ø—Ä–µ–¥–µ–ª–∏–º –¥–µ–π—Å—Ç–≤–∏—è, –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏—Å—Ç–µ–º—ã:</p>

<pre><code>astra linux # cat /etc/cgroup.sh 
mkdir -p /dev/memory
mount -t cgroup -o memory cgroup /dev/memory
mkdir -m 0777 /dev/memory/denytest
</code></pre>

<p>–¢–æ—á–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî <code>/dev/memory</code>, –∏–º—è –≥—Ä—É–ø–ø—ã ‚Äî <code>denytest</code>.</p>
<p>–í Cgroups —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: –≤—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –ø–æ—Ç–æ–º–∫–∞–º.</p>

<h2>4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>

<p>–î–æ–±–∞–≤–∏–º –≤ —Ñ–∞–π–ª <code>.bashrc</code> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <code>testuser</code>:</p>

<pre><code>if [ "$PS1" ] ; then
    mkdir -m 0700 /dev/memory/denytest/$$
    echo $$ > /dev/memory/denytest/$$/tasks
    echo 134216704 > /dev/memory/denytest/$$/memory.limit_in_bytes
fi
</code></pre>

<p>–ß–∏—Å–ª–æ <code>134216704</code> —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç 128 –ú–ë ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–∞–º—è—Ç–∏ –≤ –±–∞–π—Ç–∞—Ö.  
<code>$$</code> ‚Äî PID —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.</p>

<p>–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ <code>/proc/cgroups</code>:</p>

<pre><code>astra linux # cat /proc/cgroups 
#subsys_name    hierarchy    num_cgroups    enabled
cpuset    0    1    1
ns    0    1    1
cpu    0    1    1
cpuacct    0    1    1
memory    1    10    1
devices    0    1    1
freezer    0    1    1
blkio    0    1    1
</code></pre>

<p>–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <strong>testuser</strong> —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ <strong>128 –ú–ë</strong> –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏.</p>

<h2>5. –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</h2>

<p>–§–∞–π–ª <code>.bashrc</code> –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –ß—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π, –º–æ–∂–Ω–æ –ø–æ–º–µ—Å—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ <code>/etc/bash/bashrc</code> –∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É:</p>

<pre><code>CG_USER=`whoami`
if [ "${CG_USER}" = "testuser" ] ...
</code></pre>

<div class="note">
  üí° –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ–≥–æ –ª–∏—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
</div>

<footer>
    (c) vesna
</footer>
</body>
</html>

